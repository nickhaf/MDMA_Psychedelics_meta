---
title: "MDMA/Psychadelics multi-level meta analysis"
subtitle: "Sensitivity Analyses"
author: Nicklas Hafiz
date: now
format: 
  html:
    toc: true
    toc-depth: 4
    theme: flatly
    embed-resources: true
    fig-width: 10
    fig-height: 8
bibliography:
  - grateful-refs.bib
  - references.bib
---

```{r load packages}
#| warning: false
#| message: false
#| echo: false

# restore the library from the LOCK-file:
renv::restore()

library(here)
library(metafor)
library(dmetar)
library(psych)
library(grateful)
library(ggtext)
library(tidyverse)
library(extrafont)
library(rstatix)
library(ggbrace)

file_sources <- list.files(
  path = here::here("R"),
  pattern = "*.R"
)
source(here::here("R", file_sources[1]))
# source(here::here("R", file_sources[2])) # This reads and prepares the data
dat_maBerlin <- readRDS(here::here("data", "dat_maBerlin.RDS"))

```

# Introduction
The analysis follows the chapter [Fitting Three-Level Meta-Analysis Models in R](https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/multilevel-ma.html#multilevel-R) from the book [Doing Meta-Analysis in R](https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/), @harrer2021doing. 

```{r}
#| echo: false
cite_packages(output = "paragraph", out.dir = ".")
```

```{r results='asis'}
#| echo: false
summary_tables <- lapply(dat_maBerlin[1:3], function(x) {
  describeBy(x[, c("N", "es", "se_es")], skew = FALSE, group = x$drugType)
})

summary_tables[[4]] <- describe(dat_maBerlin[[4]][, c("N", "es", "se_es")], skew = FALSE)
names(summary_tables) <- file_sources
```


# Sensitivity analyses
In some cases redundant predictors get dropped because there are not enough cases with one of the predictors (e.g., sensitivity_psilocybin only inlcudes psychedelics).

```{r}
# Nonconvergence for this analysis, see: http://www.metafor-project.org/doku.php/tips:convergence_problems_rma_mv
dat_maBerlin[[3]] <- dat_maBerlin[[3]] %>% dplyr::select(-sensitivity_lsd)

sensitivity_analyses <- lapply(dat_maBerlin[1:3], fit_sensitivity, mods = ~ drugType - 1)
sensitivity_contrasts <- list()
sensitivity_contrasts[[1]] <- fit_contrasts(sensitivity_analyses[[1]][c("sensitivity_speed", "sensitivity_accuracy", "sensitivity_highestWeight", "sensitivity_highQuality")])
sensitivity_contrasts[[2]] <- fit_contrasts(sensitivity_analyses[[2]][c("sensitivity_speed", "sensitivity_accuracy", "sensitivity_highestWeight", "sensitivity_highQuality")])
sensitivity_contrasts[[3]] <- fit_contrasts(sensitivity_analyses[[3]][c("sensitivity_accuracy", "sensitivity_highestWeight", "sensitivity_highQuality")])

names(sensitivity_contrasts) <- names(sensitivity_analyses[1:3])

sensitivity_analyses[[4]] <- fit_sensitivity(dat_maBerlin[[4]])
names(sensitivity_analyses) <- names(dat_maBerlin)

sensitivity_summary <- lapply(sensitivity_analyses, function(domain) {
  lapply(domain, summary)
})
```


# Results

::: {.panel-tabset}


## Attention

::: {.panel-tabset}

### Speed
```{r}
sensitivity_summary[["20240115_MABerlin_attention.csv"]]["sensitivity_speed"]
sensitivity_contrasts[["20240115_MABerlin_attention.csv"]]["sensitivity_speed"]
```

### Accuracy
```{r}
sensitivity_summary[["20240115_MABerlin_attention.csv"]]["sensitivity_accuracy"]
sensitivity_contrasts[["20240115_MABerlin_attention.csv"]]["sensitivity_accuracy"]
```

### Highest Weight
```{r}
sensitivity_summary[["20240115_MABerlin_attention.csv"]]["sensitivity_highestWeight"]
sensitivity_contrasts[["20240115_MABerlin_attention.csv"]]["sensitivity_highestWeight"]
```

### Psilocybin
```{r}
sensitivity_summary[["20240115_MABerlin_attention.csv"]]["sensitivity_psilocybin"]
```

### High Quality
```{r}
sensitivity_summary[["20240115_MABerlin_attention.csv"]]["sensitivity_highQuality"]
sensitivity_contrasts[["20240115_MABerlin_attention.csv"]]["sensitivity_highQuality"]
```


:::

## Executive

::: {.panel-tabset}

### Speed
```{r}
sensitivity_summary[["20240115_MABerlin_executive.csv"]]["sensitivity_speed"]
sensitivity_contrasts[["20240115_MABerlin_executive.csv"]]["sensitivity_speed"]
```

### Accuracy
```{r}
sensitivity_summary[["20240115_MABerlin_executive.csv"]]["sensitivity_accuracy"]
sensitivity_contrasts[["20240115_MABerlin_executive.csv"]]["sensitivity_accuracy"]
```

### Highest Weight
```{r}
sensitivity_summary[["20240115_MABerlin_executive.csv"]]["sensitivity_highestWeight"]
sensitivity_contrasts[["20240115_MABerlin_executive.csv"]]["sensitivity_highestWeight"]
```

### Psilocybin
```{r}
sensitivity_summary[["20240115_MABerlin_executive.csv"]]["sensitivity_psilocybin"]
```

### LSD
```{r}
sensitivity_summary[["20240115_MABerlin_executive.csv"]]["sensitivity_lsd"]
```

### High Quality
```{r}
sensitivity_summary[["20240115_MABerlin_executive.csv"]]["sensitivity_highQuality"]
sensitivity_contrasts[["20240115_MABerlin_executive.csv"]]["sensitivity_highQuality"]
```


:::

## Memory

::: {.panel-tabset}

### Speed
```{r}
sensitivity_summary[["20240115_MABerlin_memory.csv"]]["sensitivity_speed"]
```

### Accuracy
```{r}
sensitivity_summary[["20240115_MABerlin_memory.csv"]]["sensitivity_accuracy"]
sensitivity_contrasts[["20240115_MABerlin_memory.csv"]]["sensitivity_accuracy"]
```

### Highest Weight
```{r}
sensitivity_summary[["20240115_MABerlin_memory.csv"]]["sensitivity_highestWeight"]
sensitivity_contrasts[["20240115_MABerlin_memory.csv"]]["sensitivity_highestWeight"]
```

### Psilocybin
```{r}
sensitivity_summary[["20240115_MABerlin_memory.csv"]]["sensitivity_psilocybin"]
```

### LSD
Did not converge.
```{r, eval = FALSE}
sensitivity_summary[["20240115_MABerlin_memory.csv"]]["sensitivity_lsd"]
```

### High Quality
```{r}
sensitivity_summary[["20240115_MABerlin_memory.csv"]]["sensitivity_highQuality"]
sensitivity_contrasts[["20240115_MABerlin_memory.csv"]]["sensitivity_highQuality"]
```


:::

## Microdosing
::: {.panel-tabset}

### Highest Weight
```{r}
sensitivity_summary[["20240115_MABerlin_microdosing"]]["sensitivity_highestWeight"]
```

### Psilocybin
```{r}
sensitivity_summary[["20240115_MABerlin_microdosing.csv"]]["sensitivity_psilocybin"]
```



:::

:::

# Interpretation

- `Variance Components`:
    * sigma^2.1 contains the level 3 between-cluster variance.
    * sigma^2.2 shows the variance within clusters (level 2).
- `Test of Moderators`: Indicates differences between the subgroups mdma & psychadelics.  
- `Model Results`
    * `estimate` is our estimated pooled effect. 
- `$I^2$`: 
    * $I^2$ quantifies the amount of variation not attributable to sampling error. In three level models, it is split into a part attributable to true effect size differences within clusters (level 2) and between cluster variation (level 3). 
We have 2 $I^2$ values per model quantifying the percentage of total variation associated with either level 2 or level 3. 

# References
